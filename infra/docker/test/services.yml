services:
  bff-service:
    build:
      dockerfile: Dockerfile
      context: ../../../bff-service
    working_dir: /bff-service
    volumes:
      - ../../../bff-service:/bff-service
      - ../../../config:/config
      - ../../../postgres:/postgres
      - ../../../clickhouse:/clickhouse
      - ../../../rabbitmq:/rabbitmq
      - ../../../redis:/redis
    profiles:
      - bff
    container_name: bff
    stdin_open: true
    tty: true
    environment:
      - DNS=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:5432/${POSTGRES_DB}?sslmode=disable&options=-c%20search_path%3Dmarketplace
      - PORT=3000
      - PORT_EXTERNAL=${PORT_EXTERNAL}
      - HOST_EXTERNAL=${HOST_EXTERNAL}
      - RedirectURL=/bff/callback
      - HYDRA_ADMIN_URL=http://hydra:4445
      - HYDRA_PUBLIC_URL=http://hydra:4444
      - CLIENT_ID=${CLIENT_ID}
      - CLIENT_SECRET=${CLIENT_SECRET}
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_PORT=9000
      - GOOGLE_OAUTH2_CLIENT_ID=${GOOGLE_OAUTH2_CLIENT_ID}
      - GOOGLE_OAUTH2_CLIENT_SECRET=${GOOGLE_OAUTH2_CLIENT_SECRET}
      - GOOGLE_OAUTH2_REDIRECT_URI=${GOOGLE_OAUTH2_REDIRECT_URI}
      - PROFILE=${PROFILE}
      - REDIS_HOST=${REDIS_HOST}
    networks:
      - ${NETWORK_APPLICATION}
    depends_on:
      - db
      - cache
      - broker
      - clickhouse
  cache-updater-service:
    build:
      dockerfile: Dockerfile
      context: ../../../cache-updater
    working_dir: /app
    profiles:
      - back
    container_name: cacheUpdater
    stdin_open: true
    tty: true
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - BROKER=${BROKER}
      - RABBITMQ_CHAT_CACHE_UPDATER_QUEUE=${RABBITMQ_CHAT_CACHE_UPDATER_QUEUE}
    networks:
      - ${NETWORK_APPLICATION}
    volumes:
      - ../../../cache-updater:/app
    depends_on:
      - cache
      - broker
  broker-email-service:
    build:
      dockerfile: Dockerfile
      context: ../../../broker-email-service
    working_dir: /broker-email-service
    profiles:
      - back
    container_name: brokerEmail
    stdin_open: true
    tty: true
    environment:
      - RABBITMQ_USER_DB_UPDATER_QUEUE=${RABBITMQ_USER_DB_UPDATER_QUEUE}
      - BROKER=${BROKER}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
    networks:
      - ${NETWORK_APPLICATION}
    volumes:
      - ../../../broker-email-service:/broker-email-service
      - ../../../rabbitmq:/rabbitmq
    depends_on:
      broker:
        condition: service_healthy
  db-updater-service:
    build:
      dockerfile: Dockerfile
      context: ../../../db-updater
    working_dir: /app  
    profiles:
      - back
    container_name: dbUpdater
    stdin_open: true
    tty: true
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:5432/${POSTGRES_DB}?sslmode=disable&options=-c%20search_path%3Dmarketplace
      - BROKER=${BROKER}
      - RABBITMQ_CHAT_DB_UPDATER_QUEUE=${RABBITMQ_CHAT_DB_UPDATER_QUEUE}
    networks:
      - ${NETWORK_APPLICATION}
    volumes:
      - ../../../db-updater:/app
    depends_on:
      - db
      - broker
  db-broker-service:
    build:
      dockerfile: Dockerfile
      context: ../../../db-broker-service
    working_dir: /app  
    profiles:
      - back
    container_name: DbBroker
    stdin_open: true
    tty: true
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:5432/${POSTGRES_DB}?sslmode=disable&options=-c%20search_path%3Dmarketplace
      - RABBITMQ_USER_DB_UPDATER_QUEUE=${RABBITMQ_USER_DB_UPDATER_QUEUE}
      - RABBITMQ_USER_DB_UPDATER_EXCHANGE=${RABBITMQ_USER_DB_UPDATER_EXCHANGE}
      - BROKER=${BROKER}
    networks:
      - ${NETWORK_APPLICATION}
    volumes:
      - ../../../db-broker-service:/app
      - ../../../postgres:/postgres
    depends_on:
      - db
      - broker
  ws-service:
    build:
      dockerfile: Dockerfile
      context: ../../../ws-service
    container_name: ws
    profiles:
      - ws
    tty: true
    stdin_open: true
    environment:
      - MIX_ENV=dev
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE}
      - RABBITMQ_HOST=broker
    ports:
      - 4000:4000
    volumes:
      - ../../../ws-service:/ws-service
    depends_on:
      - broker
    networks:
      - ${NETWORK_APPLICATION}
  front:
    container_name: front
    profiles:
      - front
    working_dir: /app
    entrypoint: npm run dev
    tty: true
    stdin_open: true
    environment:
      - VITE_HOST=${HOST_URL}
      - VITE_WS=${HOST_WS}
      - VITE_CLIENT_ID=${CLIENT_ID}
      - VITE_PROFILE=${PROFILE}
    ports:
     - 5173:5173
    volumes:
      - ../../../front:/app
    networks:
      - ${NETWORK_APPLICATION}
    depends_on:
      - envoy
  solana-service:
    build:
      dockerfile: Dockerfile
      context: ../../solana-service
    profiles:
      - solana
    working_dir: /app/
    restart: always
    entrypoint: [ "air"]
    container_name: solana-service
    tty: true
    stdin_open: true
    environment:
      - PROGRAMID=${PROGRAMID}
      - BROKER=${BROKER}
    volumes:
      - ../../solana-service:/app
    networks:
      - ${NETWORK_APPLICATION}
  scrap-service:
    build:
      dockerfile: Dockerfile
      context: ../../../scrap-service
    working_dir: /app/
    profiles:
      - scrap
    command: [ "celery", "-A", "main", "worker", "--loglevel=debug", "-Q", "${SCRAPY_QUEUE}" ]
    container_name: scrap-worker
    tty: true
    stdin_open: true
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - BROKER=${BROKER}
      - PORT=8000
      - TOTAL_POSTS=${TOTAL_POSTS}
      - USERNAME_INSTA=${USERNAME_INSTA}
      - PASSWORD_INSTA=${PASSWORD_INSTA}
      - SCRAPY_QUEUE=${SCRAPY_QUEUE}
    volumes:
      - ../../../scrap-service:/app
    depends_on:
      - broker
    networks:
      - ${NETWORK_APPLICATION}
  beat-service:
    build:
      dockerfile: Dockerfile
      context: ../../../beat-service
    working_dir: /beat-service/
    profiles:
      - scrap
    container_name: beat
    entrypoint: [ "celery", "-A", "main", "beat", "--loglevel=debug"]
    tty: true
    stdin_open: true
    environment:
      - BROKER=${BROKER}
      - CRON_HOUR=${CRON_HOUR}
      - CRON_MINUTE=${CRON_MINUTE}
      - RECOMENDER_QUEUE=${RECOMENDER_QUEUE}
      - SCRAPY_QUEUE=${SCRAPY_QUEUE}
    volumes:
      - ../../../beat-service:/beat-service
    depends_on:
      - broker
      - scrap-service
    networks:
      - ${NETWORK_APPLICATION}
  recomender-service:
    build:
      dockerfile: Dockerfile
      context: ../../../recomender-service
    working_dir: /recomender-service/
    profiles:
      - scrap
    command: [ "celery", "-A", "main", "worker","--loglevel=debug", "-Q", "${RECOMENDER_QUEUE}" ]
    container_name: recomender
    tty: true
    stdin_open: true
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      - BROKER=${BROKER}
      - PORT=8000
      - RECOMENDER_QUEUE=${RECOMENDER_QUEUE}
      - TOTAL_POSTS=${TOTAL_POSTS}
      - CACHE=redis://cache:6379/0
      - CLICKHOUSE_USER=${CLICKHOUSE_USER}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    volumes:
      - ../../../recomender-service:/recomender-service
    depends_on:
      - broker
      - db
      - cache
    networks:
      - ${NETWORK_APPLICATION}
  mediamtx-service:
    build:
      dockerfile: Dockerfile
      context: ../../../mediamtx-service
    container_name: mediamtx-service
    profiles:
      - media
    ports:
      - 3001:3001
    volumes:
      - ../../../mediamtx-service:/app
    environment:
      - HYDRA_PUBLIC_URL=http://hydra:4444
      - TIME_SEC_WAIT_RTMP_CONECTION=60
      - PORT=3001
    networks:
      - ${NETWORK_APPLICATION}

